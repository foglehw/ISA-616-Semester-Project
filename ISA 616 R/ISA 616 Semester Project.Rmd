---
title: "The Effect of Country Wide Factors on Citizen's Average Healthy Life Expectency"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Project Overview

In this project linear regression models are used to attempt to explain the importance 
of country wide factors on average healthy life expectancy(HLE) of citizens. This analysis has two objectives:

1. Highlight relevant factors countries governments' need concern themselves with when balancing
average HLE and authority. 
2. Highlight relevant factors countries citizens' should focus on in order to maximize
their HLE.

Models created within this report are based on data provided by the World Happiness Report from 2020

## Data Summary

The data from the World Happiness Report of 2020 is stored in the following 26 variables: country name, year, happiness (Life Ladder), GDP per capita, social support, freedom to make life choices, generosity, perception of corruption, positive affect, negative affect, confidence in government, democratic quality, standard deviation of happiness by country year, standard deviation of mean happiness by country year, GINI index world bank estimate, GINI of household income, and most people can be trusted, and healthy healthy life expectancy. 

A numeric value for happiness was obtained by asking surveyors to rank their current happiness on a scale from 0 to 10 and averaging the results. 

Numeric values for social support, freedom to make life choices, generosity, confidence in national government, democratic quality, delivery quality, and perception of corruption were obtained by asking questions such as the following for freedom to make life choices, "Are you satisfied or dissatisfied with your freedom to choose what you do with your life?" and encoding yes or no responses as a 1 or a 0 respectively. The average of said responses is what populates the data. 

Numeric data for positive and negative affect were obtained in a similar fashion, but with 3 questions rather than 1. 

The variable most people can be trusted is split into the following increments: 1981-1984, 1989-1993, 1994-1998, 1999-2004, 2005-2009, and 2010-2014. The values populating these increments were gathered in similar ways to variables such as social support.

## Data PreProcessing

Before model comparison can occur, an analysis of data completeness and data relevancy must first occur. An output of data missingness follows:

```{r dataLoad}
library(DataExplorer)
happy = read.csv("HappyData.csv", stringsAsFactors = TRUE)
plot_missing(happy)
```

Reflecting on the fact that a large part of the purpose of these analysis is deducing the factors 
that affect HLE from both perspectives, monitoring changes to the relevance of these factors over time is not included within the scope. With this in mind, variables that track these statistics, have a large portion of missing values, or both have been removed from the data set. These variables include The 8 variables that are track the whether most people can be trusted and the World Bank
GINI Index estimate.


```{r dataClean}
library(dplyr)
happy<-select(happy, -Most.people.can.be.trusted..Gallup)
happy<-select(happy, -Most.people.can.be.trusted..WVS.round.1981.1984)
happy<-select(happy, -Most.people.can.be.trusted..WVS.round.1989.1993)
happy<-select(happy, -Most.people.can.be.trusted..WVS.round.1999.2004)
happy<-select(happy, -Most.people.can.be.trusted..WVS.round.1994.1998)
happy<-select(happy, -Most.people.can.be.trusted..WVS.round.2010.2014)
happy<-select(happy, -Most.people.can.be.trusted..WVS.round.2005.2009)
happy<-select(happy, -GINI.index..World.Bank.estimate.)
```

Variables with an acceptable level of missing values, under 50%, are to have values missing values imputed by filling in blank values with the mean. Variables that fall under this category are Social Support, Negative Affect, Positive Affect, Log GPD per Capita, Freedom to Make Life Choices, HLE at birth, Generosity, Perceptions of Corruption, Delivery Quality, Democratic Quality, GINI Index World Bank Estimate Average 2000-2017, Confidence in National Government, and GINI of Household Income Reported in Gallup by WP5 Year. Though there are values within this data set that still slice by time, INI Index World Bank Estimate Average 2000-2017 and GINI of Household Income Reported in Gallup by WP5 Year, they aggregate more than just 1 years worth of data and as such can still be useful to the analysis. 



```{r impute}
happy$Social.support[is.na(happy$Social.support)]<-median(happy$Social.support, na.rm = TRUE)
happy$Negative.affect[is.na(happy$Negative.affect)]<-median(happy$Negative.affect, na.rm = TRUE)
happy$Positive.affect[is.na(happy$Positive.affect)]<-median(happy$Positive.affect, na.rm = TRUE)
happy$Log.GDP.per.capita[is.na(happy$Log.GDP.per.capita)]<-median(happy$Log.GDP.per.capita, na.rm = TRUE)
happy$Freedom.to.make.life.choices[is.na(happy$Freedom.to.make.life.choices)]<-median(happy$Social.support, na.rm = TRUE)
happy$Healthy.life.expectancy.at.birth[is.na(happy$Healthy.life.expectancy.at.birth)]<-median(happy$Healthy.life.expectancy.at.birth, na.rm = TRUE)
happy$Generosity[is.na(happy$Generosity)]<-median(happy$Generosity, na.rm = TRUE)
happy$Perceptions.of.corruption[is.na(happy$Perceptions.of.corruption)]<-median(happy$Perceptions.of.corruption, na.rm = TRUE)
happy$Delivery.Quality[is.na(happy$Delivery.Quality)]<-median(happy$Delivery.Quality, na.rm = TRUE)
happy$Democratic.Quality[is.na(happy$Democratic.Quality)]<-median(happy$Democratic.Quality, na.rm = TRUE)
happy$GINI.index..World.Bank.estimate...average.2000.2017..unbalanced.panel[is.na(happy$GINI.index..World.Bank.estimate...average.2000.2017..unbalanced.panel)]<-median(happy$GINI.index..World.Bank.estimate...average.2000.2017..unbalanced.panel, na.rm = TRUE)
happy$Confidence.in.national.government[is.na(happy$Confidence.in.national.government)]<-median(happy$Confidence.in.national.government, na.rm = TRUE)
happy$gini.of.household.income.reported.in.Gallup..by.wp5.year[is.na(happy$gini.of.household.income.reported.in.Gallup..by.wp5.year)]<-median(happy$gini.of.household.income.reported.in.Gallup..by.wp5.year, na.rm = TRUE)
```

```{r}
library(countrycode)
happy$continent <- countrycode(sourcevar = happy[, "Country.name"],
                            origin = "country.name",
                            destination = "continent")
happy$continent <- as.factor(happy$continent)
happy[is.na(happy)] <- "Europe"
happy <- select(happy, -Country.name)
plot_missing(happy)
```

## Model Creation

```{r ModelPrep}
set.seed(5)
trainIndex = sample(1:nrow(happy), size = round(0.7*nrow(happy)), replace=FALSE)
happy.train = happy[trainIndex, ]
happy.valid = happy[-trainIndex, ]
f = formula(Healthy.life.expectancy.at.birth~.)
f.interactions = formula(Healthy.life.expectancy.at.birth~(.)^2)
null<-lm(Healthy.life.expectancy.at.birth~1, data=happy.train)
full<-lm(f, data=happy.train)
full.interaction<-lm(f.interactions, data=happy.train)
```

```{r StepWiseForward}
forward.happy = step(null, scope=list(lower=null, upper=full), direction = "forward", trace=0, k=2)
forward.happy.interaction = step(null, scope=list(lower=null, upper=full.interaction), direction = "forward", trace=0, k=2)
```

```{r StepWiseBackward}
backward.happy = step(full, scope=list(lower=null, upper=full), direction = "backward", trace=0, k=2)
backward.happy.interaction = step(full.interaction, scope=list(lower=null, upper=full.interaction), direction = "backward", trace=0, k=2)
```

```{r StepWiseBoth}
both.happy = step(null, scope=list(lower=null, upper=full), direction = "both", trace=0, k=2)
both.happy.interaction = step(null, scope=list(lower=null, upper=full.interaction), direction = "both", trace=0, k=2)
```

```{r ForwardModelComparison}
forward.predict = as.data.frame(predict(forward.happy, happy.valid, interval = "prediction"))
r2valid.forward<-sum((happy.valid$Healthy.life.expectancy.at.birth-forward.predict$fit)^2)/sum((happy.valid$Healthy.life.expectancy.at.birth-mean(happy.valid$Healthy.life.expectancy.at.birth))^2)
r2valid.forward=1-r2valid.forward
ase.forward<-sum((happy.valid$Healthy.life.expectancy.at.birth-forward.predict$fit)^2)/nrow(happy.valid)

forward.predict.interaction = as.data.frame(predict(forward.happy.interaction, happy.valid, interval = "prediction"))
r2valid.forward.interaction<-sum((happy.valid$Healthy.life.expectancy.at.birth-forward.predict.interaction$fit)^2)/sum((happy.valid$Healthy.life.expectancy.at.birth-mean(happy.valid$Healthy.life.expectancy.at.birth))^2)
r2valid.forward.interaction=1-r2valid.forward.interaction
ase.forward.interaction<-sum((happy.valid$Healthy.life.expectancy.at.birth-forward.predict.interaction$fit)^2)/nrow(happy.valid)
```

```{r BackwardModelComparison}
backward.predict = as.data.frame(predict(backward.happy, happy.valid, interval = "prediction"))
r2valid.backward<-sum((happy.valid$Healthy.life.expectancy.at.birth-backward.predict$fit)^2)/sum((happy.valid$Healthy.life.expectancy.at.birth-mean(happy.valid$Healthy.life.expectancy.at.birth))^2)
r2valid.backward=1-r2valid.backward
ase.backward<-sum((happy.valid$Healthy.life.expectancy.at.birth-backward.predict$fit)^2)/nrow(happy.valid)

backward.predict.interaction = as.data.frame(predict(backward.happy.interaction, happy.valid, interval = "prediction"))
r2valid.backward.interaction<-sum((happy.valid$Healthy.life.expectancy.at.birth-backward.predict.interaction$fit)^2)/sum((happy.valid$Healthy.life.expectancy.at.birth-mean(happy.valid$Healthy.life.expectancy.at.birth))^2)
r2valid.backward.interaction=1-r2valid.backward.interaction
ase.backward.interaction<-sum((happy.valid$Healthy.life.expectancy.at.birth-backward.predict.interaction$fit)^2)/nrow(happy.valid)
```

```{r BothModelComparison}
both.predict = as.data.frame(predict(both.happy, happy.valid, interval = "prediction"))
r2valid.both<-sum((happy.valid$Healthy.life.expectancy.at.birth-both.predict$fit)^2)/sum((happy.valid$Healthy.life.expectancy.at.birth-mean(happy.valid$Healthy.life.expectancy.at.birth))^2)
r2valid.both=1-r2valid.both
ase.both<-sum((happy.valid$Healthy.life.expectancy.at.birth-both.predict$fit)^2)/nrow(happy.valid)

both.predict.interaction = as.data.frame(predict(both.happy.interaction, happy.valid, interval = "prediction"))
r2valid.both.interaction<-sum((happy.valid$Healthy.life.expectancy.at.birth-both.predict.interaction$fit)^2)/sum((happy.valid$Healthy.life.expectancy.at.birth-mean(happy.valid$Healthy.life.expectancy.at.birth))^2)
r2valid.both.interaction=1-r2valid.both.interaction
ase.both.interaction<-sum((happy.valid$Healthy.life.expectancy.at.birth-both.predict.interaction$fit)^2)/nrow(happy.valid)
```

``` {r DisplayModelComplexity}
library(ggplot2)
df <- data.frame (R2  = c(r2valid.forward, r2valid.forward.interaction, r2valid.backward, r2valid.backward.interaction, r2valid.both, r2valid.both.interaction),
                  ASE = c(ase.forward, ase.forward.interaction, ase.backward, ase.backward.interaction, ase.both, ase.backward.interaction),
                  NumOfVariables = c(length(forward.happy$coefficients), length(forward.happy.interaction$coefficients), length(backward.happy$coefficients), length(backward.happy.interaction$coefficients), length(both.happy$coefficients), length(both.happy.interaction$coefficients)),
                  ModelType = factor(c("Forward", "Forward Interaction", "Backward", "Backward Interaction", "Both", "Both Interaction"), levels=c("Forward", "Forward Interaction", "Backward", "Backward Interaction", "Both", "Both Interaction"))
                  )

ggplot(data=df, aes(x=ModelType, y=R2, fill=ModelType)) +
    geom_bar(stat="identity")

ggplot(data=df, aes(x=ModelType, y=ASE, fill=ModelType)) +
    geom_bar(stat="identity")

ggplot(data=df, aes(x=ModelType, y=NumOfVariables, fill=ModelType)) +
    geom_bar(stat="identity")
```
